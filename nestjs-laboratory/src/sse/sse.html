<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SSE í…ŒìŠ¤íŠ¸ í˜ì´ì§€</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }

      .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .connect-btn {
        background-color: #4caf50;
        color: white;
      }

      .connect-btn:hover:not(:disabled) {
        background-color: #45a049;
      }

      .disconnect-btn {
        background-color: #f44336;
        color: white;
      }

      .disconnect-btn:hover:not(:disabled) {
        background-color: #da190b;
      }

      .clear-btn {
        background-color: #ff9800;
        color: white;
      }

      .clear-btn:hover {
        background-color: #e68900;
      }

      .status {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .status-item {
        background: #e3f2fd;
        padding: 10px 15px;
        border-radius: 5px;
        border-left: 4px solid #2196f3;
      }

      .status-item.connected {
        background: #e8f5e8;
        border-left-color: #4caf50;
      }

      .status-item.disconnected {
        background: #ffebee;
        border-left-color: #f44336;
      }

      .logs {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        height: 400px;
        overflow-y: auto;
        background: #fafafa;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.4;
      }

      .log-entry {
        margin-bottom: 8px;
        padding: 5px;
        border-radius: 3px;
      }

      .log-info {
        background: #e3f2fd;
        border-left: 3px solid #2196f3;
      }

      .log-success {
        background: #e8f5e8;
        border-left: 3px solid #4caf50;
      }

      .log-error {
        background: #ffebee;
        border-left: 3px solid #f44336;
      }

      .log-data {
        background: #fff3e0;
        border-left: 3px solid #ff9800;
      }

      .timestamp {
        color: #666;
        font-size: 11px;
      }

      .server-url {
        width: 300px;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-right: 10px;
      }

      .endpoint-selector {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-right: 10px;
      }

      .chunk-input,
      .interval-input {
        width: 120px;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-right: 10px;
        text-align: center;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }

      .stat-number {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 12px;
        opacity: 0.9;
      }

      /* ëŒ€í™” UI ìŠ¤íƒ€ì¼ */
      .chat-container {
        display: none;
        border: 1px solid #ddd;
        border-radius: 8px;
        height: 300px;
        display: flex;
        flex-direction: column;
      }

      .chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background: #f9f9f9;
        border-radius: 8px 8px 0 0;
      }

      .message {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 8px;
        max-width: 80%;
        word-wrap: break-word;
      }

      .message.user {
        background: #007bff;
        color: white;
        margin-left: auto;
        text-align: right;
      }

      .message.assistant {
        background: white;
        border: 1px solid #ddd;
        margin-right: auto;
      }

      .message.system {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        color: #6c757d;
        text-align: center;
        font-style: italic;
        max-width: 100%;
      }

      .message-time {
        font-size: 10px;
        opacity: 0.7;
        margin-top: 5px;
      }

      .chat-input-area {
        padding: 15px;
        border-top: 1px solid #ddd;
        background: white;
        border-radius: 0 0 8px 8px;
      }

      .chat-input-container {
        display: flex;
        gap: 10px;
        align-items: flex-end;
      }

      .chat-input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        resize: vertical;
        min-height: 40px;
        max-height: 120px;
        font-family: inherit;
      }

      .send-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        white-space: nowrap;
      }

      .send-btn:hover:not(:disabled) {
        background: #0056b3;
      }

      .send-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <h1>ğŸš€ SSE (Server-Sent Events) í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h1>

    <div class="container">
      <div class="controls">
        <input type="text" id="serverUrl" class="server-url" value="http://localhost:3000" placeholder="ì„œë²„ URL" />
        <select id="endpoint" class="endpoint-selector">
          <option value="/sse/interactive">ëŒ€í™”í˜• SSE (ì‚¬ìš©ì ì…ë ¥)</option>
          <option value="/sse/events">ê¸°ë³¸ ë°ì´í„° ìŠ¤íŠ¸ë¦¼</option>
          <option value="/sse/heartbeat">í•˜íŠ¸ë¹„íŠ¸</option>
          <option value="/sse/multi-events">ë‹¤ì¤‘ ì´ë²¤íŠ¸</option>
        </select>
        <input type="number" id="chunkSize" class="chunk-input" value="300" min="10" max="10000" placeholder="ì²­í¬ í¬ê¸°" />
        <input type="number" id="interval" class="interval-input" value="2000" min="100" max="60000" placeholder="ê°„ê²©(ms)" />
        <button id="connectBtn" class="connect-btn">ì—°ê²°</button>
        <button id="disconnectBtn" class="disconnect-btn" disabled>ì—°ê²° í•´ì œ</button>
        <button id="clearBtn" class="clear-btn">ë¡œê·¸ ì§€ìš°ê¸°</button>
      </div>

      <div class="status">
        <div id="connectionStatus" class="status-item disconnected"><strong>ì—°ê²° ìƒíƒœ:</strong> <span id="statusText">ì—°ê²° ì•ˆë¨</span></div>
        <div class="status-item"><strong>í˜„ì¬ ì‹œê°„:</strong> <span id="currentTime"></span></div>
      </div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="messageCount">0</div>
          <div class="stat-label">ìˆ˜ì‹ ëœ ë©”ì‹œì§€</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="connectionTime">0</div>
          <div class="stat-label">ì—°ê²° ì‹œê°„ (ì´ˆ)</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="avgLatency">0</div>
          <div class="stat-label">í‰ê·  ì§€ì—°ì‹œê°„ (ms)</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="dataReceived">0</div>
          <div class="stat-label">ìˆ˜ì‹  ë°ì´í„° (KB)</div>
        </div>
      </div>
    </div>

    <!-- ëŒ€í™”í˜• ì±„íŒ… UI -->
    <div class="container" id="chatContainer" style="display: none">
      <h3>ğŸ’¬ ì‹¤ì‹œê°„ ëŒ€í™”</h3>
      <div class="chat-container" id="chatWindow">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
          <div class="chat-input-container">
            <textarea id="chatInput" class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (Shift+Enterë¡œ ì¤„ë°”ê¿ˆ, Enterë¡œ ì „ì†¡)" rows="1"></textarea>
            <button id="sendChatBtn" class="send-btn" disabled>ì „ì†¡</button>
          </div>
          <div style="font-size: 12px; color: #666; margin-top: 8px">ğŸ’¡ íŒ: "ì•ˆë…•", "í…ŒìŠ¤íŠ¸", "ê¸´ ì‘ë‹µ" ë“±ì˜ í‚¤ì›Œë“œë¥¼ í¬í•¨í•´ë³´ì„¸ìš”</div>
        </div>
      </div>
    </div>

    <!-- ê¸°ì¡´ ë©”ì‹œì§€ ì „ì†¡ UI (í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€) -->
    <div class="container" id="messageContainer" style="display: none">
      <h3>ğŸ’¬ ë©”ì‹œì§€ ì „ì†¡ (ë ˆê±°ì‹œ)</h3>
      <div style="display: flex; gap: 10px; margin-bottom: 15px">
        <input
          type="text"
          id="messageInput"
          placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
          style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px"
        />
        <button id="sendBtn" class="connect-btn" disabled>ì „ì†¡</button>
      </div>
    </div>

    <div class="container">
      <h3>ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸</h3>
      <div id="logs" class="logs"></div>
    </div>

    <script>
      let eventSource = null;
      let messageCount = 0;
      let totalLatency = 0;
      let totalDataReceived = 0;
      let connectionStartTime = null;
      let connectionTimer = null;
      let clientId = null;

      // DOM ìš”ì†Œë“¤
      const connectBtn = document.getElementById('connectBtn');
      const disconnectBtn = document.getElementById('disconnectBtn');
      const clearBtn = document.getElementById('clearBtn');
      const sendBtn = document.getElementById('sendBtn');
      const sendChatBtn = document.getElementById('sendChatBtn');
      const messageInput = document.getElementById('messageInput');
      const chatInput = document.getElementById('chatInput');
      const messageContainer = document.getElementById('messageContainer');
      const chatContainer = document.getElementById('chatContainer');
      const chatMessages = document.getElementById('chatMessages');
      const chatWindow = document.getElementById('chatWindow');
      const serverUrl = document.getElementById('serverUrl');
      const endpoint = document.getElementById('endpoint');
      const chunkSize = document.getElementById('chunkSize');
      const interval = document.getElementById('interval');
      const connectionStatus = document.getElementById('connectionStatus');
      const statusText = document.getElementById('statusText');
      const logs = document.getElementById('logs');
      const currentTime = document.getElementById('currentTime');

      // í†µê³„ ìš”ì†Œë“¤
      const messageCountEl = document.getElementById('messageCount');
      const connectionTimeEl = document.getElementById('connectionTime');
      const avgLatencyEl = document.getElementById('avgLatency');
      const dataReceivedEl = document.getElementById('dataReceived');

      // í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸
      function updateCurrentTime() {
        currentTime.textContent = new Date().toLocaleString('ko-KR');
      }
      setInterval(updateCurrentTime, 1000);
      updateCurrentTime();

      // ë¡œê·¸ ì¶”ê°€ í•¨ìˆ˜
      function addLog(message, type = 'info') {
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry log-${type}`;

        const timestamp = new Date().toLocaleTimeString('ko-KR');
        logEntry.innerHTML = `
              <span class="timestamp">[${timestamp}]</span> ${message}
          `;

        logs.appendChild(logEntry);
        logs.scrollTop = logs.scrollHeight;
      }

      // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
      function addChatMessage(content, type = 'system', isStreaming = false) {
        let messageDiv;

        if (isStreaming && type === 'assistant') {
          // ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì¸ ì–´ì‹œìŠ¤í„´íŠ¸ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
          const existingMessages = chatMessages.querySelectorAll('.message.assistant');
          const lastMessage = existingMessages[existingMessages.length - 1];

          if (lastMessage && lastMessage.classList.contains('streaming')) {
            const contentDiv = lastMessage.querySelector('.message-content');
            if (contentDiv) {
              contentDiv.textContent += content;
              chatMessages.scrollTop = chatMessages.scrollHeight;
              return lastMessage;
            }
          }
        }

        messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;

        if (isStreaming) {
          messageDiv.classList.add('streaming');
        }

        const timestamp = new Date().toLocaleTimeString('ko-KR');
        messageDiv.innerHTML = `
          <div class="message-content">${content}</div>
          <div class="message-time">${timestamp}</div>
        `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        return messageDiv;
      }

      // ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ ì²˜ë¦¬
      function finishStreaming() {
        const streamingMessages = chatMessages.querySelectorAll('.message.streaming');
        streamingMessages.forEach((msg) => {
          msg.classList.remove('streaming');
        });
      }

      // í†µê³„ ì—…ë°ì´íŠ¸
      function updateStats() {
        messageCountEl.textContent = messageCount;

        if (connectionStartTime) {
          const connectionTime = Math.floor((Date.now() - connectionStartTime) / 1000);
          connectionTimeEl.textContent = connectionTime;
        }

        if (messageCount > 0) {
          avgLatencyEl.textContent = Math.round(totalLatency / messageCount);
        }

        dataReceivedEl.textContent = (totalDataReceived / 1024).toFixed(1);
      }

      // ì—”ë“œí¬ì¸íŠ¸ë³„ ê¸°ë³¸ê°’ ì„¤ì •
      endpoint.addEventListener('change', function () {
        const selectedEndpoint = endpoint.value;
        const isInteractive = selectedEndpoint === '/sse/interactive';

        // ëŒ€í™”í˜• ëª¨ë“œì¼ ë•Œ ì±„íŒ… UI í‘œì‹œ
        chatContainer.style.display = isInteractive ? 'block' : 'none';
        messageContainer.style.display = 'none'; // ë ˆê±°ì‹œ UIëŠ” ìˆ¨ê¹€

        if (selectedEndpoint === '/sse/heartbeat') {
          chunkSize.value = '50';
          chunkSize.disabled = true;
          interval.value = '5000';
          interval.disabled = false;
        } else if (selectedEndpoint === '/sse/interactive') {
          chunkSize.value = '300';
          chunkSize.disabled = false;
          interval.disabled = true;
          interval.value = '1000';
        } else {
          chunkSize.disabled = false;
          interval.disabled = false;
          if (selectedEndpoint === '/sse/events') {
            chunkSize.value = '300';
            interval.value = '2000';
          } else if (selectedEndpoint === '/sse/multi-events') {
            chunkSize.value = '300';
            interval.value = '1500';
          }
        }
      });

      // ì—°ê²° í•¨ìˆ˜
      function connect() {
        if (eventSource) {
          disconnect();
        }

        const url = serverUrl.value + endpoint.value;
        const params = new URLSearchParams();

        if (endpoint.value !== '/sse/interactive') {
          params.append('chunkSize', chunkSize.value);
          params.append('interval', interval.value);
        }

        const fullUrl = params.toString() ? `${url}?${params}` : url;
        addLog(`ğŸ”„ ì—°ê²° ì‹œë„: ${fullUrl}`, 'info');

        try {
          eventSource = new EventSource(fullUrl);
          connectionStartTime = Date.now();

          // ì—°ê²° íƒ€ì´ë¨¸ ì‹œì‘
          connectionTimer = setInterval(updateStats, 1000);

          eventSource.onopen = function (event) {
            addLog('âœ… SSE ì—°ê²° ì„±ê³µ!', 'success');
            connectionStatus.className = 'status-item connected';
            statusText.textContent = 'ì—°ê²°ë¨';
            connectBtn.disabled = true;
            disconnectBtn.disabled = false;

            // ëŒ€í™”í˜• ëª¨ë“œì—ì„œ ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€
            if (endpoint.value === '/sse/interactive') {
              addChatMessage('ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤. ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'system');
            }
          };

          eventSource.onmessage = function (event) {
            handleMessage(event, 'message');
          };

          // ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤
          eventSource.addEventListener('connected', function (event) {
            handleMessage(event, 'connected');
            try {
              const data = JSON.parse(event.data);
              if (data.clientId) {
                clientId = data.clientId;
                addLog(`ğŸ†” í´ë¼ì´ì–¸íŠ¸ ID: ${clientId}`, 'info');
              }
            } catch (e) {
              console.warn('Failed to parse connected event data:', e);
            }
          });

          eventSource.addEventListener('heartbeat', function (event) {
            handleMessage(event, 'heartbeat');
          });

          eventSource.addEventListener('notification', function (event) {
            handleMessage(event, 'notification');
          });

          eventSource.addEventListener('waiting-input', function (event) {
            handleMessage(event, 'waiting-input');
            sendBtn.disabled = false;
            sendChatBtn.disabled = false;
          });

          eventSource.addEventListener('user-input-received', function (event) {
            handleMessage(event, 'user-input-received');
            sendBtn.disabled = true;
            sendChatBtn.disabled = true;
          });

          eventSource.addEventListener('response', function (event) {
            handleMessage(event, 'response');

            // ì±„íŒ… UIì— ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ í‘œì‹œ
            if (endpoint.value === '/sse/interactive') {
              try {
                const data = JSON.parse(event.data);
                if (data.content || data.message) {
                  addChatMessage(data.content || data.message, 'assistant', true);
                }
              } catch (e) {
                console.warn('Failed to parse response data:', e);
              }
            }
          });

          eventSource.addEventListener('response-complete', function (event) {
            handleMessage(event, 'response-complete');
            sendBtn.disabled = false;
            sendChatBtn.disabled = false;
            finishStreaming();
          });

          eventSource.onerror = function (event) {
            addLog('âŒ SSE ì—°ê²° ì˜¤ë¥˜ ë°œìƒ', 'error');
            console.error('SSE Error:', event);

            if (eventSource.readyState === EventSource.CLOSED) {
              addLog('ğŸ”Œ ì—°ê²°ì´ ì„œë²„ì— ì˜í•´ ì¢…ë£Œë¨', 'error');
              disconnect();
            }
          };
        } catch (error) {
          addLog(`âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
          console.error('Connection error:', error);
        }
      }

      // ë©”ì‹œì§€ ì²˜ë¦¬ í•¨ìˆ˜
      function handleMessage(event, eventType) {
        messageCount++;

        try {
          const data = JSON.parse(event.data);
          const messageSize = new Blob([event.data]).size;
          totalDataReceived += messageSize;

          // ì§€ì—°ì‹œê°„ ê³„ì‚°
          if (data.timestamp) {
            const latency = Date.now() - new Date(data.timestamp).getTime();
            totalLatency += latency;

            addLog(`ğŸ“¨ [${eventType}] ID: ${event.lastEventId || 'N/A'}, ì§€ì—°ì‹œê°„: ${latency}ms, í¬ê¸°: ${messageSize}bytes`, 'data');
          } else {
            addLog(`ğŸ“¨ [${eventType}] ID: ${event.lastEventId || 'N/A'}, í¬ê¸°: ${messageSize}bytes`, 'data');
          }

          // ë°ì´í„° ë‚´ìš© ë¡œê¹… (ì²˜ìŒ 100ìë§Œ)
          const content = data.message || data.content || JSON.stringify(data);
          if (content.length > 100) {
            addLog(`ğŸ“ ë°ì´í„°: "${content.substring(0, 100)}..."`, 'info');
          } else {
            addLog(`ğŸ“ ë°ì´í„°: ${content}`, 'info');
          }
        } catch (error) {
          addLog(`âš ï¸ JSON íŒŒì‹± ì˜¤ë¥˜: ${error.message}`, 'error');
          addLog(`ğŸ“¨ ì›ë³¸ ë°ì´í„°: ${event.data}`, 'data');
        }

        updateStats();
      }

      // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜ (ì±„íŒ…ìš©)
      async function sendChatMessage() {
        const message = chatInput.value.trim();
        if (!message) {
          addLog('âš ï¸ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
          return;
        }

        if (!clientId) {
          addLog('âš ï¸ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”', 'error');
          return;
        }

        const chunkSizeValue = parseInt(chunkSize.value) || 300;

        try {
          sendChatBtn.disabled = true;

          // ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ì±„íŒ…ì— í‘œì‹œ
          addChatMessage(message, 'user');
          addLog(`ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡: "${message}"`, 'info');

          const response = await fetch(`${serverUrl.value}/sse/send-message`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              clientId: clientId,
              message: message,
              chunkSize: chunkSizeValue,
            }),
          });

          const result = await response.json();

          if (result.success) {
            addLog('âœ… ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ', 'success');
            chatInput.value = '';
            autoResizeTextarea(chatInput);
          } else {
            addLog(`âŒ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ${result.message}`, 'error');
            sendChatBtn.disabled = false;
          }
        } catch (error) {
          addLog(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
          sendChatBtn.disabled = false;
        }
      }

      // ë ˆê±°ì‹œ ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
      async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message || !clientId) {
          addLog('âš ï¸ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”', 'error');
          return;
        }

        const chunkSizeValue = parseInt(chunkSize.value) || 300;

        try {
          sendBtn.disabled = true;
          addLog(`ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡: "${message}"`, 'info');

          const response = await fetch(`${serverUrl.value}/sse/send-message`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              clientId: clientId,
              message: message,
              chunkSize: chunkSizeValue,
            }),
          });

          const result = await response.json();

          if (result.success) {
            addLog('âœ… ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ', 'success');
            messageInput.value = '';
          } else {
            addLog(`âŒ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ${result.message}`, 'error');
            sendBtn.disabled = false;
          }
        } catch (error) {
          addLog(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
          sendBtn.disabled = false;
        }
      }

      // ì—°ê²° í•´ì œ í•¨ìˆ˜
      function disconnect() {
        if (eventSource) {
          eventSource.close();
          eventSource = null;
          addLog('ğŸ”Œ SSE ì—°ê²° í•´ì œë¨', 'info');
        }

        if (connectionTimer) {
          clearInterval(connectionTimer);
          connectionTimer = null;
        }

        connectionStatus.className = 'status-item disconnected';
        statusText.textContent = 'ì—°ê²° ì•ˆë¨';
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
        sendBtn.disabled = true;
        sendChatBtn.disabled = true;
        connectionStartTime = null;
        clientId = null;
      }

      // ë¡œê·¸ ì§€ìš°ê¸° í•¨ìˆ˜
      function clearLogs() {
        logs.innerHTML = '';
        chatMessages.innerHTML = '';
        messageCount = 0;
        totalLatency = 0;
        totalDataReceived = 0;
        updateStats();
        addLog('ğŸ§¹ ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤', 'info');
      }

      // í…ìŠ¤íŠ¸ì—ë¦¬ì–´ ìë™ í¬ê¸° ì¡°ì ˆ
      function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
      }

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      connectBtn.addEventListener('click', connect);
      disconnectBtn.addEventListener('click', disconnect);
      clearBtn.addEventListener('click', clearLogs);
      sendBtn.addEventListener('click', sendMessage);
      sendChatBtn.addEventListener('click', sendChatMessage);

      // ì±„íŒ… ì…ë ¥ ì²˜ë¦¬
      chatInput.addEventListener('input', function () {
        autoResizeTextarea(this);
      });

      chatInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (!sendChatBtn.disabled) {
            sendChatMessage();
          }
        }
      });

      // ë ˆê±°ì‹œ ì…ë ¥ ì²˜ë¦¬
      messageInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter' && !sendBtn.disabled) {
          sendMessage();
        }
      });

      // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì—°ê²° í•´ì œ
      window.addEventListener('beforeunload', disconnect);

      // ì´ˆê¸° ì„¤ì •
      endpoint.dispatchEvent(new Event('change'));

      // ì´ˆê¸° ë¡œê·¸
      addLog('ğŸ‘‹ SSE í…ŒìŠ¤íŠ¸ í˜ì´ì§€ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!', 'info');
      addLog('ğŸ’¡ ëŒ€í™”í˜• SSEë¥¼ ì„ íƒí•˜ì—¬ ì‹¤ì‹œê°„ ì±„íŒ…ì„ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”', 'info');
      addLog('ğŸ“ ì²­í¬ í¬ê¸°: 10~10,000ì, ê°„ê²©: 100ms~60ì´ˆ ë²”ìœ„ì—ì„œ ì„¤ì • ê°€ëŠ¥', 'info');
    </script>
  </body>
</html>
